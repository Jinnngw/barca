# 后端架构设计文档

##  项目概述

Barca 是一个基于 Spring Cloud 微服务架构的 AI 对话系统，支持文本和语音交互，具备角色扮演、会话管理、语音合成等核心功能。系统采用现代化的微服务设计理念，提供高可用、可扩展的 AI 对话服务。

###  项目目标
- 提供流畅的 AI 对话体验
- 支持多模态交互（文本+语音）
- 实现角色扮演和个性化对话
- 构建高可用的微服务架构
- 支持水平扩展和负载均衡

###  核心特性
- **多模态交互**: 支持文本输入和语音输入
- **角色扮演**: 支持不同角色的人设对话
- **会话管理**: 完整的对话上下文维护
- **语音合成**: AI 回复支持语音播放
- **微服务架构**: 高可用、可扩展的服务设计
- **实时响应**: 低延迟的对话体验

##  系统架构

### 整体架构图
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端应用       │    │   API Gateway   │    │  Eureka Server  │
│   (Web/Mobile)  │◄──►│   (Gateway)     │◄──►│   (Registry)    │
│                 │    │                 │    │                 │
│ • Web App       │    │ • 路由转发      │    │ • 服务注册      │
│ • Mobile App    │    │ • 负载均衡      │    │ • 健康检查      │
│ • 语音录制      │    │ • 跨域处理      │    │ • 服务发现      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
                    ┌─────────────────────────┐
                    │    Provider Service     │
                    │   (Business Logic)      │
                    │                         │
                    │ • 会话管理              │
                    │ • 消息处理              │
                    │ • 业务逻辑              │
                    └─────────────────────────┘
                                │
                    ┌───────────┼───────────┐
                    ▼           ▼           ▼
            ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
            │ Chat Client │ │ ASR Client  │ │ TTS Client  │
            │ (AI Chat)   │ │ (Speech2Text)│ │ (Text2Speech)│
            │             │ │             │ │             │
            │ • 对话生成  │ │ • 语音识别  │ │ • 语音合成  │
            │ • 上下文    │ │ • 音频解析  │ │ • 音频生成  │
            │ • 角色扮演  │ │ • 文本输出  │ │ • Base64    │
            └─────────────┘ └─────────────┘ └─────────────┘
                                │
                    ┌───────────┼───────────┐
                    ▼           ▼           ▼
            ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
            │  AI Chat    │ │    ASR      │ │    TTS      │
            │   Service   │ │   Service   │ │   Service   │
            │ (Python)    │ │ (Python)    │ │ (Python)    │
            └─────────────┘ └─────────────┘ └─────────────┘
```

### 架构层次说明

#### 1. 接入层 (Access Layer)
- **前端应用**: Web应用、移动应用
- **API Gateway**: 统一入口，路由分发
- **负载均衡**: 请求分发和故障转移

#### 2. 服务层 (Service Layer)
- **注册中心**: Eureka Server
- **业务服务**: Provider Service
- **网关服务**: Gateway Server

#### 3. 集成层 (Integration Layer)
- **Feign客户端**: 服务间通信
- **HTTP客户端**: 外部服务调用
- **消息队列**: 异步处理（可扩展）

#### 4. 外部服务层 (External Service Layer)
- **AI服务**: Python实现的AI模型服务
- **存储服务**: 文件存储、数据库（可扩展）

##  技术栈

### 后端技术栈

#### 核心框架
- **Spring Boot**: 2.3.12 - 微服务基础框架
- **Spring Cloud**: Hoxton.SR12 - 微服务全家桶
- **Spring Web**: RESTful API 开发

#### 微服务组件
- **Netflix Eureka**: 服务注册与发现
- **OpenFeign**: 声明式 HTTP 客户端
- **Spring Cloud Gateway**: API 网关

#### 开发工具
- **Maven**: 3.x - 项目构建和依赖管理
- **Lombok**: 代码简化工具
- **Jackson**: JSON 序列化/反序列化（Spring Boot 内置）

#### 运行时环境
- **JDK**: 1.8
- **JVM**: HotSpot

### 外部服务技术栈

#### AI 服务 (Python)
- **AI对话服务**: 自定义 AI Chat API (Python)
- **语音识别**: ASR (Automatic Speech Recognition) API
- **语音合成**: TTS (Text-to-Speech) API

### 存储方案
- **内存存储**: HashMap (当前实现)
- **会话管理**: 内存映射存储

##  模块设计

### 1. Eureka Server (服务注册中心)
**端口**: 8761  
**模块路径**: `eureka-server/`

#### 核心功能
- **服务注册**: 微服务实例注册
- **服务发现**: 客户端服务发现
- **健康检查**: 服务健康状态监控
- **负载均衡**: 服务实例负载均衡
- **故障转移**: 服务实例故障检测

#### 技术实现
```java
@SpringBootApplication
@EnableEurekaServer
public class EurekaServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaServerApplication.class, args);
    }
}
```

#### 配置详情
```yaml
server:
  port: 8761
eureka:
  client:
    fetch-registry: false          # 不获取注册表
    register-with-eureka: false    # 不注册自己
    service-url:
      defaultZone: http://localhost:8761/eureka/
  instance:
    prefer-ip-address: true        # 使用IP地址
```

#### 监控端点
- **健康检查**: `http://localhost:8761/actuator/health`
- **服务列表**: `http://localhost:8761/`
- **应用信息**: `http://localhost:8761/actuator/info`

### 2. Gateway Server (API网关)
**端口**: 8080 (默认)  
**模块路径**: `gateway-server/`

#### 核心功能
- **统一入口**: 所有外部请求的统一入口
- **路由转发**: 根据路径转发到对应服务
- **负载均衡**: 请求分发到多个服务实例
- **跨域处理**: CORS 跨域资源共享

#### 技术实现
```java
@SpringBootApplication
public class GatewayServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(GatewayServerApplication.class, args);
    }
}
```

#### 路由配置
```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: provider-service
          uri: lb://provider
          predicates:
            - Path=/api/v1/**
          filters:
            - StripPrefix=1
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods: "*"
            allowedHeaders: "*"
```

#### 扩展功能
- **跨域处理**: CORS 配置
- **路由转发**: 请求路径映射

### 3. Provider Service (业务服务)
**端口**: 8082  
**模块路径**: `provider/`

#### 核心功能
- **会话管理**: 创建、维护、销毁会话
- **消息处理**: 文本和语音消息处理
- **AI服务集成**: 调用外部AI服务
- **多媒体处理**: 音频文件处理
- **角色管理**: AI角色配置和管理
- **历史记录**: 对话历史存储和检索

#### 服务注册
```yaml
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
  instance:
    prefer-ip-address: true
spring:
  application:
    name: provider
```

#### 外部服务配置
```yaml
ai:
  chat:
    base-url: http://127.0.0.1:8000
  asr:
    base-url: http://127.0.0.1:8000
  tts:
    base-url: http://127.0.0.1:8000
```

#### 性能配置
```yaml
feign:
  client:
    config:
      default:
        connectTimeout: 5000    # 连接超时
        readTimeout: 60000      # 读取超时
```

##  核心模块详解

### Provider Service 模块结构

```
provider/
├── ai/                          # AI服务客户端
│   ├── AsrClient.java          # 语音识别客户端
│   ├── ChatClient.java         # AI对话客户端
│   └── TtsClient.java          # 语音合成客户端
├── controller/                  # 控制器层
│   ├── SessionController.java  # 会话控制器
│   └── MediaController.java    # 媒体控制器
├── core/                       # 核心业务逻辑
│   └── MemoryRepo.java         # 内存存储仓库
├── dto/                        # 数据传输对象
│   ├── MessageItem.java        # 消息项
│   ├── SendMessageResponse.java# 发送消息响应
│   ├── CreateSessionRequest.java# 创建会话请求
│   └── ...
└── ProviderApplication.java    # 应用启动类
```

### 详细模块分析

#### 1. AI 服务客户端层 (`ai/`)

##### ChatClient (AI对话客户端)
```java
@FeignClient(name = "ai-chat", url = "${ai.chat.base-url}")
public interface ChatClient {
    @PostMapping("/v1/chat")
    ChatResponse chat(@RequestBody ChatRequest request);
    
    // 内部类定义
    @Data @AllArgsConstructor @NoArgsConstructor
    class ChatRequest {
        private String characterId;    // 角色ID
        private List<Message> messages; // 历史消息
    }
    
    @Data @AllArgsConstructor @NoArgsConstructor
    class Message {
        private String role;    // 角色：user/assistant
        private String content; // 消息内容
    }
    
    @Data @AllArgsConstructor @NoArgsConstructor
    class ChatResponse {
        private String text;    // AI回复文本
    }
}
```

**功能特点**:
- 支持角色扮演对话
- 历史上下文维护
- HTTP同步调用

##### AsrClient (语音识别客户端)
```java
@FeignClient(name = "ai-asr", url = "${ai.asr.base-url}")
public interface AsrClient {
    @PostMapping("/v1/asr")
    AsrResult asr(@RequestPart("audio") MultipartFile audio);
    
    @Data @AllArgsConstructor @NoArgsConstructor
    class AsrResult {
        private String text;    // 识别出的文本
    }
}
```

**功能特点**:
- 多格式音频支持 (mp3, wav, ogg等)
- MultipartFile 文件上传处理

##### TtsClient (语音合成客户端)
```java
@FeignClient(name = "ai-tts", url = "${ai.tts.base-url}")
public interface TtsClient {
    @PostMapping("/v1/tts")
    TtsResult tts(@RequestBody TtsRequest request);
    
    @Data @AllArgsConstructor @NoArgsConstructor
    class TtsRequest {
        private String text;    // 要合成的文本
        private String voice;   // 声音类型
    }
    
    @Data @AllArgsConstructor @NoArgsConstructor
    class TtsResult {
        private String audioData;    // Base64音频数据
        private String format;       // 音频格式
        private Integer duration;    // 音频时长(ms)
    }
}
```

#### 2. 控制器层 (`controller/`)

##### SessionController (会话控制器)
**主要接口**:
```java
@RestController
@RequestMapping("/api/v1/sessions")
public class SessionController {
    
    // 创建会话
    @PostMapping("/createSession")
    public String createSession(@RequestParam String characterId);
    
    // 发送文本消息
    @PostMapping("/{sessionId}/messages")
    public SendMessageResponse sendText(@PathVariable String sessionId, 
                                       @RequestBody SendTextRequest request);
    
    // 发送音频消息
    @PostMapping(value = "/{sessionId}/audio", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    public SendMessageResponse sendAudio(@PathVariable String sessionId,
                                        @RequestPart("audio") MultipartFile audio);
}
```

**业务逻辑**:
1. **会话创建**: 生成UUID作为会话ID，绑定角色
2. **文本处理**: 保存用户消息 → 调用AI → 保存AI回复 → TTS合成
3. **音频处理**: ASR识别 → 文本处理流程 → 返回音频数据

##### MediaController (媒体控制器)
**功能**: 媒体文件处理
- 音频文件上传
- 图片文件处理
- 文件存储管理

#### 3. 核心业务层 (`core/`)

##### MemoryRepo (内存存储仓库)
```java
@Component
public class MemoryRepo {
    private final Map<String, String> sessionToCharacter = new HashMap<>();
    private final Map<String, List<MessageItem>> sessionMessages = new HashMap<>();
    
    // 核心方法
    public String createSession(String characterId);
    public Optional<String> getCharacterId(String sessionId);
    public void appendMessage(String sessionId, MessageItem message);
    public List<MessageItem> listMessages(String sessionId, int limit, String cursor);
    public static MessageItem msg(String role, String text, String audioUrl);
}
```

**存储策略**:
- **会话映射**: `sessionId -> characterId`
- **消息存储**: `sessionId -> List<MessageItem>`
- **内存存储**: HashMap实现，快速访问
- **数据持久化**: 当前为内存存储，重启后数据丢失

#### 4. 数据传输对象层 (`dto/`)

##### MessageItem (消息项)
```java
@Data @AllArgsConstructor @NoArgsConstructor @Builder
public class MessageItem {
    private String id;              // 消息唯一ID
    private String role;            // 角色：user/assistant/system
    private String text;            // 文本内容
    private String audioUrl;        // 音频URL (兼容性)
    private String audioData;       // Base64音频数据
    private String audioFormat;     // 音频格式：mp3/wav/ogg
    private Integer audioDuration;  // 音频时长(毫秒)
    private Instant time;           // 消息时间戳
}
```

##### SendMessageResponse (发送消息响应)
```java
@Data @AllArgsConstructor @NoArgsConstructor @Builder
public class SendMessageResponse {
    private MessageItem userMessage;        // 用户消息
    private MessageItem assistantMessage;   // AI助手消息
}
```

**设计特点**:
- 使用Builder模式，支持链式调用
- Lombok注解简化代码
- 支持多媒体内容
- 时间戳自动生成

##  核心功能模块

### 1. 会话管理 (Session Management)
**功能描述**:
- 创建会话
- 会话状态维护
- 消息历史记录
- 角色绑定

**API接口**:
```java
POST /api/v1/sessions/createSession?characterId={id}
```

**技术实现**:
- 使用内存存储 (`MemoryRepo`)
- 会话ID使用UUID生成
- 支持多会话并发

### 2. 文本对话 (Text Chat)
**功能描述**:
- 文本消息发送
- AI智能回复
- 上下文记忆
- 语音合成

**API接口**:
```java
POST /api/v1/sessions/{sessionId}/messages
```

**技术实现**:
- FeignClient调用AI服务
- 历史消息组装
- 异步TTS处理

### 3. 语音交互 (Voice Interaction)
**功能描述**:
- 语音输入识别
- 音频文件处理
- 语音回复生成
- 多媒体响应

**API接口**:
```java
POST /api/v1/sessions/{sessionId}/audio
```

**技术实现**:
- MultipartFile处理
- ASR → Chat → TTS 流程
- Base64音频数据返回


##  数据流程

### 文本对话流程
```
用户输入 → SessionController → MemoryRepo存储 → ChatClient → AI服务
    ↓
AI回复 ← ChatResponse ← 文本处理 ← 历史消息组装
    ↓
TTS处理 → 语音合成 → 返回完整响应
```

### 语音对话流程
```
音频上传 → ASR识别 → 文本提取 → ChatClient → AI服务
    ↓
AI回复 → TTS合成 → Base64音频 → 返回响应
```

##  数据模型

### MessageItem (消息项)
```java
public class MessageItem {
    private String id;              // 消息ID
    private String role;            // 角色 (user/assistant)
    private String text;            // 文本内容
    private String audioUrl;        // 音频URL (兼容)
    private String audioData;       // Base64音频数据
    private String audioFormat;     // 音频格式
    private Integer audioDuration;  // 音频时长
    private Instant time;           // 时间戳
}
```

### SendMessageResponse (发送消息响应)
```java
public class SendMessageResponse {
    private MessageItem userMessage;        // 用户消息
    private MessageItem assistantMessage;   // AI回复消息
}
```

##  外部服务集成

### AI Chat Service
- **协议**: HTTP REST API
- **端点**: `http://127.0.0.1:8000/v1/chat`
- **功能**: 智能对话生成

### ASR Service
- **协议**: HTTP REST API
- **端点**: `http://127.0.0.1:8000/v1/asr`
- **功能**: 语音转文本

### TTS Service
- **协议**: HTTP REST API
- **端点**: `http://127.0.0.1:8000/v1/tts`
- **功能**: 文本转语音

##  部署架构

### 开发环境
```
localhost:8761  - Eureka Server
localhost:8080  - Gateway Server  
localhost:8082  - Provider Service
localhost:8000  - AI Services (Python)
```

### 生产环境建议
- 使用 Docker 容器化部署
- Nginx 反向代理
- 数据库持久化存储（MySQL/PostgreSQL）

##  安全考虑

1. **跨域处理**: Gateway层统一处理CORS
2. **文件上传**: 限制音频文件大小和格式
3. **服务间通信**: 内网通信，避免暴露敏感服务

##  性能优化

1. **缓存策略**: 会话数据内存缓存
2. **连接池**: FeignClient连接池配置
3. **负载均衡**: Eureka服务发现

##  配置管理

### 关键配置项
```yaml
# Provider Service
server:
  port: 8082
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
feign:
  client:
    config:
      default:
        connectTimeout: 5000
        readTimeout: 60000
ai:
  chat:
    base-url: http://127.0.0.1:8000
  asr:
    base-url: http://127.0.0.1:8000
  tts:
    base-url: http://127.0.0.1:8000
```

##  扩展性设计

1. **水平扩展**: 支持多实例部署
2. **存储扩展**: 可替换为数据库存储
3. **AI服务**: 支持多种AI模型切换

##  总结

Barca AI对话系统采用现代化的微服务架构，具备良好的可扩展性和维护性。通过Spring Cloud生态，实现了服务注册发现、API网关、服务调用等核心功能。系统支持文本和语音交互，为用户提供智能化的对话体验。

---
